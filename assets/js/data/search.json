[ { "title": "DPAPI", "url": "/posts/mimikatz%E4%B8%ADDPAPI%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/", "categories": "域安全, TA0006凭据访问", "tags": "DPAPI, mimikatz, TA0006凭据访问", "date": "2020-12-31 23:59:59 +0800", "snippet": "参考:How to hack a Windows passwordHow to decrypt stored Windows passwords using mimikatz and DAPA渗透技巧-离线导出Chrome浏览器中保存的密码渗透技巧-利用Masterkey离线导出Chrome浏览器中保存的密码Operational Guidance for Offensive User DPAPI AbuseDPAPI简介DPAPI全称Data Protection Application Programming Interface，是Windows提供的用于数据保护的一套接口，常见应用..." }, { "title": "Windows访问控制", "url": "/posts/Windows%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/", "categories": "域安全, 背景知识", "tags": "", "date": "2020-12-31 23:59:59 +0800", "snippet": " SRM(Security reference monitor 安全引用监视器) Ntoskrnl.exe中的一个组件，工作在内核模式下，它负责：定义访问令牌的数据结构来表示一个安全环境、执行对象的访问检查、管理特权，以及生成所有的结果安全审计消息。 LSASS(Local Security Authority Subsystem本地安全权威子系统) 工作在用户模式下，它负责：本地系统安全策略(比如允许哪些用户登录到本地机器上、密码策略、授予用户和用户组特权，以及系统安全审计设置等)、用户认证、以及发送安全审计信息到Event Log中。它在启动后，会..." }, { "title": "SPN", "url": "/posts/SPN/", "categories": "域安全, 背景知识", "tags": "spn", "date": "2020-12-31 23:59:59 +0800", "snippet": "通过SPN查询域内服务 SPN Scanning – Service Discovery without Network Port Scanning Active Directory: PowerShell script to list all SPNs used Discovering Service Accounts Without Using Privileges通过端口扫描的方式发现服务，需要连接服务机器IP，容易被发现。在域环境中，可以通过LDAP查询SPN，获取域内服务信息。Powershell$search = New-Object DirectoryServices..." }, { "title": "SMB协议与IPC$", "url": "/posts/SMB%E5%8D%8F%E8%AE%AE%E4%B8%8EIPC$/", "categories": "域安全, 背景知识", "tags": "smb, ipc$", "date": "2020-12-31 23:59:59 +0800", "snippet": "SMB协议与IPC$RPCChapter 14. Intermediary Protocolshttps://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wpo/7d2df784-557e-4fde-9281-9509653a0f17远程过程调用(Remote Procedure Call, RPC)是一种进程间通信（interprocess communication, IPC）机制，它提供在不同进程中进行数据交换和调用的功能；不同的进程可以在同一台计算机上，在局域网（LAN）上或在Internet上，所以RPC常常会..." }, { "title": "Powershell使用WMI", "url": "/posts/Powershell%E4%BD%BF%E7%94%A8WMI/", "categories": "域安全, TA0002执行", "tags": "powershell, wmi, TA0002执行", "date": "2020-12-31 23:59:59 +0800", "snippet": "一、WMI WMI提供了一套通用的API使得常用脚本语言也能很方便地管理windows资源，比如powershell，VBScript等；通过它可以访问、配置、管理和监视所有的几乎所有的 Windows 资源 WMI class是由不同的WMI Provider实现的，类别、目标相同的class会放在不同的namespace下。例如 Win32_Process和Win32_Service是由CIMWin32 Provider提供的，它们属于Root\\CIMV2 命名空间，分别代表着windows 进程和服务。 WMI Explorer是一个power..." }, { "title": "AdminSDHolder", "url": "/posts/AdminSDHolder/", "categories": "域安全, TA0003持久化", "tags": "AdminSDHolder, TA0003持久化", "date": "2020-12-31 23:59:59 +0800", "snippet": "0x00 简介AdminSDHolder是AD中的一个容器，它维护了一个ACL模板；后台程序SDPROP(Security Descriptor propagator)默认每60分钟执行一次，将受保护账户和组(如Domain Admins组)的ACL重置为AdminSDHolder中的ACL，用于确保这些关键对象的安全权限不被修改。修改AdminSDHolder ACL需要域管权限，修改的ACL由SDPROP自动应用于所有受保护的AD账户和组，从而实现域权限维持。参考：AdminSDHolder, Protected Groups and SDPROPAppendix C: Protec..." }, { "title": "Active Directory简介", "url": "/posts/ActiveDirectory%E7%AE%80%E4%BB%8B/", "categories": "域安全, 背景知识", "tags": "ActiveDirectory, ldap", "date": "2020-12-31 23:59:59 +0800", "snippet": "LDAP与ADLDAP: Lightweight Directory Access Protocol, 轻量级目录访问协议。协议只是一套抽象的标准，Windows AD就是基于LDAP协议实现的一套应用，用于提供域环境中用户及用户组的管理与认证。AD由目录服务数据库+一套访问协议组成: 它是一个树形数据库，适合用来存储不需要经常更改、需要快速查找的数据。同时，AD还是一个LDAP服务端，供client连接、查询、以及其他操作。LDAP结构和常用术语如下：一条路径上的dc, ou, cn组合起来成为dn，能唯一标识一条记录位置。Naming ContextAD使用NC将不同类型的数据归为不..." }, { "title": "Kerberoasting", "url": "/posts/Kerberoasting/", "categories": "域安全, TA0006凭据访问", "tags": "Kerberoasting, TA0006凭据访问", "date": "2020-12-31 23:59:56 +0800", "snippet": "KerberoastingSPN(Service Principal Name)SPN，即Service Principal Name，客户端通过Kerberos请求使用某种服务时，会在请求中附带上需要访问的服务的SPN名称，如文件共享服务cifs/DNS_DOMAIN_NAME，目录访问服务ldap/DNS_DOMAIN_NAME。KDC（密钥分发中心）将通过SPN来确定客户端请求访问的是主机上的哪个具体服务，因为一个主机上通常情况下同时提供多种支持Kerberos认证的服务，随后，KDC将使用该服务账号的密码哈希来对票据进行加密。一般格式长这样:service_class/hostn..." }, { "title": "利用cachedGroupPolicySettings关闭ScriptBlockLogging", "url": "/posts/%E5%88%A9%E7%94%A8cachedGroupPolicySettings%E5%85%B3%E9%97%ADScriptBlockLogging/", "categories": "域安全, TA0005防御逃逸", "tags": "ScriptBlockLogging, TA0005防御逃逸", "date": "2020-12-31 23:59:55 +0800", "snippet": "参考：PowerShell ScriptBlock Logging BypassIn Windows 10 / PowerShell 5.0, Microsoft introduced several new security features in PowerShell. These included the AMSI, Protected Event Logging, and maybe most importantly ScriptBlock logging.Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-W..." }, { "title": "DNSAdmin", "url": "/posts/DNSAdmin/", "categories": "域安全, TA0004权限升级", "tags": "DNSAdmin, TA0004权限升级", "date": "2020-12-31 23:59:55 +0800", "snippet": "0x00 简介感染DNSAdmin组用户，为DNS服务配置恶意ServerLevelPluginDll，DNS服务会以system权限加载该Dll，从而达到提权目的。参考：https://github.com/kazkansouh/DNSAdmin-DLLFeature, not bug: DNSAdmin to DC compromise in one lineAbusing DNSAdmins privilege for escalation in Active Directory0x01 DNSAdmin原理域中DNS遵循[MS-DNSP]: Domain Name Service..." }, { "title": "AS-REP Roasting", "url": "/posts/AS-REP-Roasting/", "categories": "域安全, TA0006凭据访问", "tags": "AS-REP Roasting, TA0006凭据访问", "date": "2020-12-31 23:59:54 +0800", "snippet": "0x00 简介如果账户设置了Do not require Kerberos preauthentication，则在AS-REQ阶段就不需要用Client Master Key加密timestamp，用于KDC验证自身。因此，攻击者可以伪装成任意用户发出AS-REQ，而AES-REP中的Session Key是由Client Master Key加密的；一旦攻击者拿到AES-REP后便可暴力破解，如果能顺利解密说明破解成功。参考：Roasting AS-REPs域渗透——AS-REPRoastingA Generalized Framework for Kerberos Pre-Auth..." }, { "title": "RID Hijacking", "url": "/posts/RID-Hijacking/", "categories": "域安全, TA0003持久化", "tags": "RIDHijacking, TA0003持久化", "date": "2020-12-31 23:59:53 +0800", "snippet": "RID Hijacking0x00 简介通过操作SAM注册表，修改本地账户RID为500，实现RID劫持参考：Persistence – RID HijackingRid Hijacking: When Guests Become Admins0x01 相关概念使用psexec.exe以system权限打开注册表HKEY_LOCAL_MACHINE\\SAM\\SAM\\Domains\\Account\\Users，Powershell获取部分SID：# 获取本地账户SIDPS C:\\Users\\win10&amp;gt; Get-LocalUser | Format-Table Name, S..." }, { "title": "Zerologon CVE-2020-1472 原理及利用", "url": "/posts/ZeroLogon%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/", "categories": "域安全, TA0004权限升级", "tags": "Zerologon, TA0004权限升级", "date": "2020-12-31 23:59:52 +0800", "snippet": "Zerologon CVE-2020-1472 原理及利用0x00 前言参考https://www.secura.com/uploads/whitepapers/Zerologon.pdfhttps://threadreaderapp.com/thread/1306280553281449985.html0x01 Netlogon Remote ProtocolNetlogon是windows域主机上的一个服务，用于维护计算机和域控制器之间的安全通道，对用户和服务进行身份验证。服务描述如下： Maintains a secure channel between this comput..." }, { "title": "NTLM认证与利用", "url": "/posts/NTLM%E8%AE%A4%E8%AF%81%E4%B8%8E%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92/", "categories": "域安全, TA0008横向移动", "tags": "NTLM, pass-the-hash, TA0008横向移动", "date": "2020-12-31 23:59:52 +0800", "snippet": "原理一、Net-NTLM协议http://d1iv3.me/2018/12/08/LM-Hash%E3%80%81NTLM-Hash%E3%80%81Net-NTLMv1%E3%80%81Net-NTLMv2%E8%AF%A6%E8%A7%A3/1. LM Hash与NT HashLM Hash与NT Hash，密码根据固定算法转成的两种Hash，LM Hash更容易被破解NTLM Hash = LM Hash + NT Hash，也有的会把NTLM Hash等同于NT Hash2. Lan Manager认证 与 NT Lan Manager其中NT Lan Manager有两个版本：..." }, { "title": "Kerberos认证与票据传递", "url": "/posts/Kerberos%E8%AE%A4%E8%AF%81%E5%8F%8A%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92/", "categories": "域安全, TA0008横向移动", "tags": "Kerberos, pass-the-ticket, TA0008横向移动", "date": "2020-12-31 23:59:52 +0800", "snippet": "原理一、Kerberos认证https://www.dazhuanlan.com/2020/02/03/5e3738460a38b/https://qili93.github.io/%E6%8A%80%E6%9C%AF%E8%A7%A3%E8%AF%BB/2017/03/14/kerebros-auth/https://en.hackndo.com/kerberos/1. Authentication Service Exchange。具体过程如下：Client向KDC的Authentication Service发送Authentication Service Request（KRB_..." }, { "title": "Dump域内凭据汇总", "url": "/posts/Dump%E5%9F%9F%E5%86%85%E5%87%AD%E6%8D%AE%E6%B1%87%E6%80%BB/", "categories": "域安全, TA0006凭据访问", "tags": "TA0006凭据访问", "date": "2020-12-31 23:59:52 +0800", "snippet": "Dump域内凭据汇总How Attackers Dump Active Directory Database Credentials读取LSASS进程内存1. 本地获取Mimikatz通过与LSA Server交互直接拿到SAM和NTDS中储存的Hash, 这种方式与读取SAM，NTDS文件拿到的信息基本一致，但直接与LSASS 交互有可能造成其crash，尤其是在域很大的情况下。privilege::debuglsadump::lsa /injectlsadump::lsa /inject /id:502lsadump::lsa /inject /name:krbtgtprivileg..." }, { "title": "DCShadow原理与抓包", "url": "/posts/DCShadow%E5%8E%9F%E7%90%86%E4%B8%8E%E6%8A%93%E5%8C%85/", "categories": "域安全, TA0003持久化", "tags": "DCShadow, TA0003持久化", "date": "2020-12-31 23:59:51 +0800", "snippet": "DCShadow笔记整理参考、摘抄于：https://blog.riskivy.com/dcshadow/#DCShadow-2https://zhuanlan.zhihu.com/p/37782341基础概念nTDSDSA对象在活动目录数据库中通过一些特殊对象以及一定的数据对象层级关系来标识某台机器是域控制器，其中，最关键的是nTDSDSA对象，该对象正是标识一台主机是域控角色的特殊对象。同时，nTDSDSA对象需要位于正确的位置，根据文档其父对象应该是一个server对象。为了注册成域控，需要插入这两个对象。server对象可以通过LDAP的add操作进行插入，nTDSDSA对象却无..." }, { "title": "SID History", "url": "/posts/SID-History/", "categories": "域安全, TA0003持久化", "tags": "SIDHistory, TA0003持久化", "date": "2020-12-31 23:59:50 +0800", "snippet": "0x00 简介攻击者在获取Domain Admins权限后，可以通过SID Hisotry给普通账户提权，用于权限维持参考：Sneaky Active Directory Persistence #14: SID History0x01 SID History SID History is an attribute that supports migration scenarios. Every user account has an associated Security IDentifier (SID) which is used to track the security pri..." }, { "title": "DCsync原理及利用", "url": "/posts/DCsync%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/", "categories": "域安全, TA0006凭据访问", "tags": "dcsync, TA0006凭据访问", "date": "2020-12-31 23:59:50 +0800", "snippet": "DCsync原理及利用原理域中的账户、密码信息是存储在域控机器上C:\\Windows\\NTDS\\NTDS.dit文件里, 以往是需要在域控机器上执行dump hash操作的；而通过DCSync，则可以从其他机器上，远程从C:\\Windows\\NTDS\\NTDS.dit中获取密码hash。相比于在域控上访问lsass.exe进程或拷贝NTDS.dit、System 文件，其噪音更小。Directory Replication Service (DRS) Remote Protocol 是一个RPC协议，用于复制和管理Active Directory中的数据。如果账户具有以下扩展权限，即可调..." }, { "title": "SSP与mimilib", "url": "/posts/SSP%E4%B8%8Emimilib/", "categories": "域安全, TA0006凭据访问", "tags": "mimikatz, ssp, TA0006凭据访问", "date": "2020-12-31 23:59:47 +0800", "snippet": "学习了以下文章，整理SSP相关笔记:Mimikatz中SSP的使用深入分析Mimikatz：SSPExploring Mimikatz - Part 2 - SSPSSPI&amp;amp;SSP SSPI(Security Support Provider Interface)这是 Windows 定义的一套接口，此接口定义了与安全有关的功能函数， 用来获得验证、信息完整性、信息隐私等安全功能，就是定义了一套接口函数用来身份验证，签名等，但是没有具体的实现。 SSP(Security Support Provider)SSPI 的实现者，对SSPI相关功能函数的具体实现。微软自己实..." }, { "title": "Mimikatz sekurlsa::wdigest原理", "url": "/posts/Mimikatz%E4%B8%ADsekurlsa-wdigest%E5%8E%9F%E7%90%86/", "categories": "域安全, TA0006凭据访问", "tags": "mimikatz, TA0006凭据访问", "date": "2020-12-31 23:59:45 +0800", "snippet": "Mimikatz sekurlsa::wdigest原理看了以下几篇文章，整理一下笔记:Mimikatz中sekurlsa::wdigest的实现Exploring Mimikatz - Part 1 - WDigest深入分析Mimikatz：WDigest简介wdigest.dll是LSASS中实现Digest Authentication的SSP，LSASS会将加密后的密码传给它，但是可以拿到密钥并解密，Mimikatz sekurlsa::wdigest就实现了这一过程。涉及凭据获取的关键步骤如下: lsasrv!LsaInitializeProtectedMemory..." } ]
